name: Monitor Organization Bot PRs

on:
  schedule:
    # Run every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch:
    inputs:
      target_repo:
        description: 'Specific repo to check (e.g., VectorInstitute/repo-name)'
        required: false
      pr_number:
        description: 'Specific PR number to process'
        required: false

permissions:
  contents: read
  issues: write

env:
  ORG_NAME: VectorInstitute

jobs:
  discover-bot-prs:
    runs-on: ubuntu-latest
    outputs:
      prs: ${{ steps.find-prs.outputs.prs }}

    steps:
      - name: Checkout bot repository
        uses: actions/checkout@v4

      - name: Find bot PRs across organization
        id: find-prs
        run: |
          # Search for all open bot PRs (Dependabot and pre-commit-ci) in the organization
          if [ -n "${{ github.event.inputs.target_repo }}" ]; then
            # Manual trigger - specific repo
            REPOS="${{ github.event.inputs.target_repo }}"
          else
            # Scheduled - read repos from CSV file
            if [ -f repos-to-monitor.csv ]; then
              REPOS=$(tail -n +2 repos-to-monitor.csv | grep -v '^$' | tr '\n' ' ')
              echo "Reading repos from repos-to-monitor.csv"
            else
              echo "Error: repos-to-monitor.csv not found"
              exit 1
            fi
          fi

          # Array to store PR information
          PRS_JSON="[]"

          # Bot authors to check
          BOT_AUTHORS=("app/dependabot" "pre-commit-ci[bot]")

          for REPO in $REPOS; do
            echo "Checking $REPO for bot PRs..."

            # Get all open PRs from each bot author
            for BOT_AUTHOR in "${BOT_AUTHORS[@]}"; do
              REPO_PRS=$(gh pr list --repo "$REPO" \
                --author "$BOT_AUTHOR" \
                --state open \
                --json number,title,url,headRefName,statusCheckRollup 2>/dev/null || echo "[]")

              if [ "$REPO_PRS" != "[]" ] && [ -n "$REPO_PRS" ]; then
                # Add repo name to each PR object in the array
                REPO_PRS=$(echo "$REPO_PRS" | jq -c "map(. + {repo: \"$REPO\"})")

                # Append to our collection
                PRS_JSON=$(echo "$PRS_JSON" | jq -c ". + $REPO_PRS")
              fi
            done
          done

          # Output the collected PRs
          echo "Found $(echo "$PRS_JSON" | jq 'length') bot PRs"
          echo "$PRS_JSON" | jq -c '.'

          # Save to output (handle GitHub Actions output size limits)
          echo "prs=$(echo "$PRS_JSON" | jq -c '.')" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.ORG_ACCESS_TOKEN }}

  process-passing-prs:
    runs-on: ubuntu-latest
    needs: discover-bot-prs
    if: needs.discover-bot-prs.outputs.prs != '[]'
    strategy:
      matrix:
        pr: ${{ fromJson(needs.discover-bot-prs.outputs.prs) }}
      max-parallel: 5
      fail-fast: false

    steps:
      - name: Checkout bot repository
        uses: actions/checkout@v4

      - name: Analyze PR status
        id: analyze
        run: |
          REPO="${{ matrix.pr.repo }}"
          PR_NUMBER="${{ matrix.pr.number }}"

          echo "Analyzing $REPO#$PR_NUMBER"

          # Get detailed status
          STATUS_JSON=$(gh pr view $PR_NUMBER --repo "$REPO" --json statusCheckRollup,reviewDecision,mergeable)

          # Check if all checks passed
          ALL_PASSED=$(echo "$STATUS_JSON" | jq -r '
            .statusCheckRollup
            | if . == null then false
              else map(select(.name != "Monitor Organization Bot PRs"))
              | all(.conclusion == "SUCCESS" or .conclusion == "NEUTRAL" or .conclusion == "SKIPPED" or .conclusion == null)
              end
          ')

          # Check if any checks failed
          HAS_FAILURES=$(echo "$STATUS_JSON" | jq -r '
            .statusCheckRollup
            | if . == null then false
              else any(.conclusion == "FAILURE")
              end
          ')

          # Check if mergeable
          MERGEABLE=$(echo "$STATUS_JSON" | jq -r '.mergeable')

          echo "all-passed=$ALL_PASSED" >> $GITHUB_OUTPUT
          echo "has-failures=$HAS_FAILURES" >> $GITHUB_OUTPUT
          echo "mergeable=$MERGEABLE" >> $GITHUB_OUTPUT

          echo "Status: all_passed=$ALL_PASSED, has_failures=$HAS_FAILURES, mergeable=$MERGEABLE"
        env:
          GH_TOKEN: ${{ secrets.ORG_ACCESS_TOKEN }}

      - name: Auto-merge passing PRs
        if: steps.analyze.outputs.all-passed == 'true' && steps.analyze.outputs.mergeable == 'MERGEABLE'
        run: |
          REPO="${{ matrix.pr.repo }}"
          PR_NUMBER="${{ matrix.pr.number }}"

          echo "âœ… All checks passed for $REPO#$PR_NUMBER - proceeding with auto-merge"

          # Check if already approved
          REVIEW_DECISION=$(gh pr view $PR_NUMBER --repo "$REPO" --json reviewDecision --jq '.reviewDecision')

          if [ "$REVIEW_DECISION" != "APPROVED" ]; then
            # Approve the PR
            cat > /tmp/approve-msg.txt <<'EOF'
          âœ… All checks passed. Auto-approving bot PR.

          ðŸ¤– *AI Engineering Maintenance Bot - Maintaining Vector Institute Repositories built by AI Engineering*
          EOF
            gh pr review $PR_NUMBER --repo "$REPO" --approve --body-file /tmp/approve-msg.txt
          fi

          # Enable auto-merge
          gh pr merge $PR_NUMBER --repo "$REPO" --auto --squash || {
            echo "âš ï¸  Auto-merge failed, may already be enabled or blocked by branch protection"
          }

          # Comment on success
          cat > /tmp/success-msg.txt <<'EOF'
          ðŸŽ‰ All checks passed! This PR will be automatically merged.

          ðŸ¤– *AI Engineering Maintenance Bot - Maintaining Vector Institute Repositories built by AI Engineering*
          EOF
          gh pr comment $PR_NUMBER --repo "$REPO" --body-file /tmp/success-msg.txt

          echo "âœ… Auto-merge configured for $REPO#$PR_NUMBER"
        env:
          GH_TOKEN: ${{ secrets.ORG_ACCESS_TOKEN }}
        continue-on-error: true

      - name: Trigger fix for failing PRs
        if: steps.analyze.outputs.has-failures == 'true'
        run: |
          REPO="${{ matrix.pr.repo }}"
          PR_NUMBER="${{ matrix.pr.number }}"

          echo "âŒ Failures detected in $REPO#$PR_NUMBER - triggering fix workflow"

          # Trigger the fix workflow via repository dispatch
          gh workflow run fix-remote-pr.yml \
            --repo ${{ github.repository }} \
            --field target_repo="$REPO" \
            --field pr_number="$PR_NUMBER"

          echo "ðŸ”§ Fix workflow triggered for $REPO#$PR_NUMBER"
        env:
          GH_TOKEN: ${{ secrets.ORG_ACCESS_TOKEN }}
        continue-on-error: true

  report-summary:
    runs-on: ubuntu-latest
    needs: [discover-bot-prs, process-passing-prs]
    if: always()

    steps:
      - name: Generate summary
        run: |
          PR_COUNT=$(echo '${{ needs.discover-bot-prs.outputs.prs }}' | jq 'length')

          echo "## Bot PR Monitor Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Organization**: ${{ env.ORG_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Bot PRs Found**: $PR_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "- **Run Time**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$PR_COUNT" -gt 0 ]; then
            echo "### PRs Processed" >> $GITHUB_STEP_SUMMARY
            echo '${{ needs.discover-bot-prs.outputs.prs }}' | \
              jq -r '.[] | "- [\(.repo)#\(.number)](\(.url)) - \(.title)"' >> $GITHUB_STEP_SUMMARY
          fi
